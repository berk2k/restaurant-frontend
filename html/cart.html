<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepet</title>
    <!-- <link rel="stylesheet" href="../css/cart.css"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">Sepetiniz</h1>
        <div id="cart-container" class="row"></div>
        <div class="text-center mt-3">
            <button id="checkout-btn" class="btn btn-success">Ã–deme Yap</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const menuItemId = localStorage.getItem('menuItemID'); // Retrieve menuItemID from localStorage

            if (menuItemId) {
                fetchCartItems(menuItemId);
            } else {
                document.getElementById('cart-container').innerHTML = '<p>No items found in the cart.</p>';
            }
        });

        function fetchCartItems(menuItemId) {
            if (!menuItemId) {
                console.error('menuItemId is undefined or null.');
                return;
            }

            const url = `https://localhost:7035/api/OrderItem/by-item/${menuItemId}`;

            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.isSuccess) {
                    displayCartItems(data.result); // Assuming "result" contains the list of cart items
                } else {
                    console.error("Error fetching cart items:", data.errorMessage);
                }
            })
            .catch(error => console.error("Error:", error));
        }

        function displayCartItems(items) {
            const cartContainer = document.getElementById('cart-container');
            cartContainer.innerHTML = ''; // Clear existing cart content

            if (items.length === 0) {
                cartContainer.innerHTML = '<p>Your cart is empty.</p>';
                return;
            }

            // Map to store aggregated cart items by menuItemID
            const aggregatedItems = {};

            // Loop over items and aggregate by menuItemID
            items.forEach(item => {
                if (aggregatedItems[item.menuItemID]) {
                    // If item already exists, increase the quantity
                    aggregatedItems[item.menuItemID].quantity += item.quantity;
                } else {
                    // If it's a new item, add it to the map
                    aggregatedItems[item.menuItemID] = { ...item };
                }
            });

            // Now we iterate over the aggregated items and create a card for each
            Object.values(aggregatedItems).forEach(item => {
                const cartItemCard = document.createElement('div');
                cartItemCard.className = 'col-lg-4 mb-3'; // Each item will have its own card in a column
                
                totalPrice = item.quantity * item.itemPrice
                cartItemCard.innerHTML = `
                    <div class="card h-100">
                        <img src="${item.itemImg}" class="card-img-top" alt="${item.itemName}">
                        <div class="card-body">
                            <h5 class="card-title">${item.itemName}</h5>
                            <p class="card-text">Price: ${totalPrice} TL</p>
                            <label for="quantity-${item.menuItemID}">Quantity:</label>
                            <input type="number" id="quantity-${item.menuItemID}" value="${item.quantity}" min="1" onchange="updateCartItemQuantity(${item.menuItemID}, this.value)">
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-danger" onclick="removeCartItem(${item.menuItemID})">Remove</button>
                        </div>
                    </div>
                `;

                cartContainer.appendChild(cartItemCard);
            });
        }

        function updateCartItemQuantity(menuItemID, newQuantity) {
            // Handle updating quantity logic here
        }

        function removeCartItem(menuItemID) {
            // Handle removing item logic here
        }

        
    </script>

</body>

</html>
